{% extends 'admin_panel/base.html' %}

{% block title %}ユーザー{% if form.instance.pk %}編集{% else %}新規作成{% endif %} - 管理者パネル{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-user"></i> 
        ユーザー{% if form.instance.pk %}編集{% else %}新規作成{% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'admin_panel:user_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> 一覧に戻る
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    {% if form.instance.pk %}
                        <i class="fas fa-edit"></i> ユーザー情報の編集
                    {% else %}
                        <i class="fas fa-user-plus"></i> 新規ユーザー作成
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_email" class="form-label">メールアドレス *</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.email.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="id_job" class="form-label">職業</label>
                            {{ form.job }}
                            {% if form.job.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.job.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_birth_year" class="form-label">生年</label>
                            {{ form.birth_year }}
                            {% if form.birth_year.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.birth_year.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                {{ form.is_active }}
                                <label class="form-check-label" for="id_is_active">
                                    アカウントを有効化
                                </label>
                            </div>
                            {% if form.is_active.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.is_active.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                {{ form.manager_flag }}
                                <label class="form-check-label" for="id_manager_flag">
                                    管理者権限を付与
                                </label>
                            </div>
                            {% if form.manager_flag.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.manager_flag.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 更新
                        </button>
                        
                        {% if form.instance.pk and not form.instance.manager_flag %}
                        <a href="{% url 'admin_panel:user_delete' form.instance.pk %}" 
                           class="btn btn-outline-danger"
                           onclick="return confirm('このユーザーを削除しますか？\n\nこの操作は取り消せません。')">
                            <i class="fas fa-trash"></i> 削除
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    {% if form.instance.pk %}
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> ユーザー情報
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>ID</th>
                        <td>{{ form.instance.id }}</td>
                    </tr>
                    <tr>
                        <th>作成日時</th>
                        <td>{{ form.instance.date_joined|date:"Y/m/d H:i" }}</td>
                    </tr>
                    <tr>
                        <th>最終ログイン</th>
                        <td>
                            {% if form.instance.last_login %}
                                {{ form.instance.last_login|date:"Y/m/d H:i" }}
                            {% else %}
                                <span class="text-muted">未ログイン</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>アカウント状態</th>
                        <td>
                            {% if form.instance.is_active %}
                                <span class="badge bg-success">有効</span>
                            {% else %}
                                <span class="badge bg-secondary">無効</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>管理者権限</th>
                        <td>
                            {% if form.instance.manager_flag %}
                                <span class="badge bg-warning">管理者</span>
                            {% else %}
                                <span class="badge bg-primary">一般ユーザー</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- ユーザー統計情報 -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> 統計情報
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="border-end">
                            <h6 class="text-primary">{{ form.instance.reviews.count }}</h6>
                            <small class="text-muted">レビュー数</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border-end">
                            <h6 class="text-success">{{ form.instance.favorites.count }}</h6>
                            <small class="text-muted">お気に入り</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <h6 class="text-info">{{ form.instance.histories.count }}</h6>
                        <small class="text-muted">予約履歴</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // フォームバリデーション
    const form = document.querySelector('form');
    const emailInput = document.getElementById('id_email');
    const passwordInput = document.getElementById('id_password');
    
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // メールアドレスの検証
        if (!emailInput.value.trim()) {
            showError(emailInput, 'メールアドレスは必須です。');
            isValid = false;
        }
        
        // パスワードの検証（新規作成時のみ）
        if (passwordInput && !passwordInput.value.trim()) {
            showError(passwordInput, 'パスワードは必須です。');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
        }
    });
    
    function showError(input, message) {
        // 既存のエラーメッセージを削除
        const existingError = input.parentNode.querySelector('.error-message');
        if (existingError) {
            existingError.remove();
        }
        
        // 新しいエラーメッセージを追加
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-danger mt-1 error-message';
        errorDiv.innerHTML = `<small>${message}</small>`;
        input.parentNode.appendChild(errorDiv);
        
        // 入力フィールドにフォーカス
        input.focus();
        input.classList.add('is-invalid');
    }
    
    // 入力時にエラー状態をクリア
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            const errorMessage = this.parentNode.querySelector('.error-message');
            if (errorMessage) {
                errorMessage.remove();
            }
        });
    });
});
</script>
{% endblock %}
