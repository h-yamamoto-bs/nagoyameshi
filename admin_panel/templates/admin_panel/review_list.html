{% extends 'admin_panel/base.html' %}

{% block title %}レビュー管理 - 管理者パネル{% endblock %}

{% block extra_css %}
<style>
    .star-rating {
        color: #ffc107;
    }
    .review-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .review-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .review-status-approved {
        color: #28a745;
    }
    .review-status-pending {
        color: #ffc107;
    }
    .review-status-rejected {
        color: #dc3545;
    }
    .review-content {
        max-height: 100px;
        overflow: hidden;
        position: relative;
    }
    .review-content.expanded {
        max-height: none;
    }
    .review-toggle {
        cursor: pointer;
        color: #007bff;
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-star"></i> レビュー管理</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-download"></i> エクスポート
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="?export=csv"><i class="fas fa-file-csv"></i> CSV</a></li>
                <li><a class="dropdown-item" href="?export=excel"><i class="fas fa-file-excel"></i> Excel</a></li>
            </ul>
        </div>
        <div class="btn-group me-2">
            {% if request.GET.show_all != 'true' %}
                <a href="?show_all=true{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-list"></i> 全件表示
                </a>
            {% else %}
                <a href="?{% if request.GET.search %}search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-th-list"></i> ページ表示
                </a>
            {% endif %}
        </div>
        <button type="button" class="btn btn-sm btn-outline-info" onclick="testAjax()">
            <i class="fas fa-flask"></i> AJAX テスト
        </button>
    </div>
</div>

<!-- 統計カード -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0">{{ total_reviews }}</div>
                        <small>総レビュー数</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-star fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0">{{ approved_reviews }}</div>
                        <small>承認済み</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0">{{ pending_reviews }}</div>
                        <small>承認待ち</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="h4 mb-0">{{ avg_rating|floatformat:1 }}</div>
                        <small>平均評価</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 表示情報 -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-light">
            <i class="fas fa-info-circle"></i>
            {% if show_all %}
                現在{{ current_page_size }}件のレビューを表示中（全件表示モード）
            {% else %}
                現在<span id="current-display-count">{{ current_page_size }}</span>件のレビューを表示中（さらに表示モード）
            {% endif %}
            {% if request.GET.search %} | 検索: "{{ request.GET.search }}"{% endif %}
            {% if request.GET.status %} | ステータス: {{ request.GET.status }}{% endif %}
            {% if request.GET.rating %} | 評価: {{ request.GET.rating }}{% endif %}
        </div>
    </div>
</div>

<!-- フィルターと検索 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="店舗名、ユーザー名で検索..." id="searchInput" value="{{ request.GET.search }}">
            <button class="btn btn-outline-secondary" type="button" onclick="applyFilters()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-2">
        <select class="form-select" id="statusFilter">
            <option value="">すべて</option>
            <option value="visible" {% if request.GET.status == 'visible' %}selected{% endif %}>表示中</option>
            <option value="hidden" {% if request.GET.status == 'hidden' %}selected{% endif %}>非表示</option>
        </select>
    </div>
    <div class="col-md-2">
        <select class="form-select" id="ratingFilter">
            <option value="">すべて</option>
            <option value="5" {% if request.GET.rating == '5' %}selected{% endif %}>★5</option>
            <option value="4" {% if request.GET.rating == '4' %}selected{% endif %}>★4</option>
            <option value="3" {% if request.GET.rating == '3' %}selected{% endif %}>★3</option>
            <option value="2" {% if request.GET.rating == '2' %}selected{% endif %}>★2</option>
            <option value="1" {% if request.GET.rating == '1' %}selected{% endif %}>★1</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="sortSelect">
            <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>投稿日（新）</option>
            <option value="created_at" {% if request.GET.sort == 'created_at' %}selected{% endif %}>投稿日（旧）</option>
            <option value="-rating" {% if request.GET.sort == '-rating' %}selected{% endif %}>評価（高）</option>
            <option value="rating" {% if request.GET.sort == 'rating' %}selected{% endif %}>評価（低）</option>
        </select>
    </div>
    <div class="col-md-2">
        <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
            <i class="fas fa-times"></i> クリア
        </button>
    </div>
</div>

<!-- レビュー一覧 -->
<div class="row" id="reviews-container">
    {% include 'admin_panel/review_cards.html' with reviews=reviews %}
    {% if not reviews %}
    <div class="col-12" id="empty-message">
        <div class="text-center py-5">
            <i class="fas fa-star fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">レビューが見つかりません</h4>
            <p class="text-muted">検索条件を変更してください。</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- さらに表示ボタン -->
{% if reviews.has_next and request.GET.show_all != 'true' %}
<div class="text-center mb-4" id="load-more-container">
    <button type="button" class="btn btn-primary" id="load-more-btn" onclick="loadMoreReviews()">
        <i class="fas fa-plus-circle"></i> さらに表示 (20件)
    </button>
    <div class="mt-2">
        <small class="text-muted">
            {{ reviews|length }}件 / {{ total_reviews }}件を表示中
        </small>
    </div>
</div>
{% endif %}

<!-- ローディング表示 -->
<div class="text-center py-3" id="loading-indicator" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">読み込み中...</span>
    </div>
    <div class="mt-2">
        <small class="text-muted">レビューを読み込み中...</small>
    </div>
</div>

<!-- 従来のページネーション（全件表示モード時のみ） -->
{% if request.GET.show_all == 'true' and reviews.has_other_pages %}
<nav aria-label="ページネーション">
    <ul class="pagination justify-content-center">
        {% if reviews.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ reviews.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}&show_all=true">前へ</a>
            </li>
        {% endif %}
        
        {% for num in reviews.paginator.page_range %}
            {% if reviews.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
            {% elif num > reviews.number|add:'-3' and num < reviews.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}&show_all=true">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if reviews.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ reviews.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}&show_all=true">次へ</a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- 全件表示時の情報 -->
{% if request.GET.show_all == 'true' %}
<div class="alert alert-info text-center mt-4">
    <i class="fas fa-info-circle"></i> 
    全{{ reviews|length }}件のレビューを表示しています
    <span class="ms-2">
        <a href="?{% if request.GET.search %}search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}" class="btn btn-sm btn-outline-secondary">
            ページ表示に戻る
        </a>
    </span>
</div>
{% endif %}

<!-- 一括操作パネル -->
<div class="fixed-bottom bg-white border-top p-3" style="display: none;" id="bulkActionPanel">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span id="selectedCount">0</span> 件選択中
            </div>
            <div>
                <button type="button" class="btn btn-outline-success btn-sm me-2" onclick="bulkApprove()">
                    <i class="fas fa-check"></i> 一括承認
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="bulkHide()">
                    <i class="fas fa-eye-slash"></i> 一括非表示
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm me-2" onclick="bulkDelete()">
                    <i class="fas fa-trash"></i> 一括削除
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSelection()">
                    <i class="fas fa-times"></i> 選択解除
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// AJAXテスト関数
function testAjax() {
    console.log('AJAX テストを開始...');
    const csrfToken = getCookie('csrftoken');
    console.log('CSRFトークン:', csrfToken);
    
    fetch('{% url "admin_panel:ajax_test" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ test: 'データ' })
    })
    .then(response => {
        console.log('レスポンス状態:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('レスポンスデータ:', data);
        if (data.success) {
            showToast('AJAX通信テスト成功！', 'success');
        } else {
            showToast('AJAX通信テスト失敗: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('AJAX エラー:', error);
        showToast('AJAX通信エラー: ' + error.message, 'error');
    });
}

// さらに表示機能
let currentPage = 1;
let isLoading = false;

function loadMoreReviews() {
    if (isLoading) return;
    
    isLoading = true;
    currentPage += 1;
    
    const loadMoreBtn = document.getElementById('load-more-btn');
    const loadingIndicator = document.getElementById('loading-indicator');
    
    // ボタンを無効化してローディング表示
    loadMoreBtn.disabled = true;
    loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 読み込み中...';
    loadingIndicator.style.display = 'block';
    
    // 現在のフィルター条件を取得
    const params = new URLSearchParams(window.location.search);
    params.set('page', currentPage);
    
    const url = window.location.pathname + '?' + params.toString();
    
    console.log('さらに表示リクエスト:', url);
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken'),
        }
    })
    .then(response => {
        console.log('レスポンス状態:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('レスポンスデータ:', data);
        
        if (data.success && data.html) {
            // 新しいレビューカードを追加
            const container = document.getElementById('reviews-container');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = data.html;
            
            // 各カードを個別に追加（アニメーション効果付き）
            const newCards = tempDiv.querySelectorAll('.review-card-item');
            newCards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    container.appendChild(card);
                    
                    // フェードインアニメーション
                    requestAnimationFrame(() => {
                        card.style.transition = 'opacity 0.5s, transform 0.5s';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    });
                }, index * 100);
            });
            
            // 新しく追加されたレビューカードにイベントリスナーを設定
            setupReviewCardEvents();
            
            // 表示件数を更新
            const currentCount = container.querySelectorAll('.review-card-item').length;
            
            // さらに表示ボタンの下の件数表示を更新
            const counterElement = document.querySelector('#load-more-container small');
            if (counterElement) {
                counterElement.innerHTML = `${currentCount}件 / ${data.total_count}件を表示中`;
            }
            
            // 上部の表示情報も更新
            const currentDisplayCount = document.getElementById('current-display-count');
            if (currentDisplayCount) {
                currentDisplayCount.textContent = currentCount;
            }
            
            // 次のページがない場合はボタンを隠す
            if (!data.has_next) {
                const loadMoreContainer = document.getElementById('load-more-container');
                loadMoreContainer.style.display = 'none';
                
                // 全件表示完了メッセージ
                const completeMessage = document.createElement('div');
                completeMessage.className = 'text-center mb-4';
                completeMessage.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 
                        全${data.total_count}件のレビューを表示しました
                    </div>
                `;
                container.parentNode.insertBefore(completeMessage, container.nextSibling);
            } else {
                // ボタンを再有効化
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerHTML = '<i class="fas fa-plus-circle"></i> さらに表示 (20件)';
            }
            
            showToast(`${newCards.length}件のレビューを追加しました`, 'success');
        } else {
            showToast('レビューの読み込みに失敗しました: ' + (data.error || '不明なエラー'), 'error');
            
            // ボタンを再有効化
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerHTML = '<i class="fas fa-plus-circle"></i> さらに表示 (20件)';
        }
    })
    .catch(error => {
        console.error('さらに表示エラー:', error);
        showToast('通信エラー: ' + error.message, 'error');
        
        // ボタンを再有効化
        loadMoreBtn.disabled = false;
        loadMoreBtn.innerHTML = '<i class="fas fa-plus-circle"></i> さらに表示 (20件)';
    })
    .finally(() => {
        isLoading = false;
        loadingIndicator.style.display = 'none';
    });
}

// フィルター適用時にページをリセット
function applyFilters() {
    currentPage = 1;
    const params = new URLSearchParams(window.location.search);
    
    const search = document.getElementById('searchInput').value;
    const status = document.getElementById('statusFilter').value;
    const rating = document.getElementById('ratingFilter').value;
    const sort = document.getElementById('sortSelect').value;
    
    // パラメータをクリア
    params.delete('search');
    params.delete('status');
    params.delete('rating');
    params.delete('sort');
    params.delete('page');
    params.delete('show_all');
    
    // 新しいパラメータを設定
    if (search) params.set('search', search);
    if (status) params.set('status', status);
    if (rating) params.set('rating', rating);
    if (sort) params.set('sort', sort);
    
    window.location.search = params.toString();
}

// フィルタークリア
function clearFilters() {
    window.location.href = window.location.pathname;
}

// レビューの表示/非表示切り替え
function toggleReviewVisibility(reviewId, isVisible) {
    console.log(`レビューID ${reviewId} の表示状態を ${isVisible} に変更中...`);
    
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        console.error('CSRFトークンが見つかりません');
        showToast('CSRFトークンが見つかりません', 'error');
        return;
    }
    
    const url = `{% url 'admin_panel:toggle_review_visibility' 0 %}`.replace('0', reviewId);
    console.log('リクエストURL:', url);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ is_visible: isVisible })
    })
    .then(response => {
        console.log('レスポンス状態:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('レスポンスデータ:', data);
        if (data.success) {
            showToast(data.message || 'レビューの表示状態を変更しました', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('エラー: ' + (data.error || '不明なエラー'), 'error');
        }
    })
    .catch(error => {
        console.error('通信エラー:', error);
        showToast('通信エラー: ' + error.message, 'error');
    });
}

// レビュー削除
function deleteReview(reviewId) {
    if (!confirm('このレビューを削除しますか？\n\nこの操作は取り消せません。')) {
        return;
    }
    
    console.log(`レビューID ${reviewId} を削除中...`);
    
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        console.error('CSRFトークンが見つかりません');
        showToast('CSRFトークンが見つかりません', 'error');
        return;
    }
    
    const url = `{% url 'admin_panel:delete_review' 0 %}`.replace('0', reviewId);
    console.log('削除リクエストURL:', url);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        }
    })
    .then(response => {
        console.log('削除レスポンス状態:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('削除レスポンスデータ:', data);
        if (data.success) {
            showToast(data.message || 'レビューを削除しました', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('削除エラー: ' + (data.error || '不明なエラー'), 'error');
        }
    })
    .catch(error => {
        console.error('削除通信エラー:', error);
        showToast('削除通信エラー: ' + error.message, 'error');
    });
}

// レビュー内容の展開/折りたたみ
function toggleContent(reviewId) {
    const content = document.getElementById(`content-${reviewId}`);
    const toggleText = document.getElementById(`toggle-text-${reviewId}`);
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        toggleText.textContent = 'もっと見る';
    } else {
        content.classList.add('expanded');
        toggleText.textContent = '折りたたむ';
    }
}

// 店舗詳細表示
function viewShop(shopId) {
    console.log('店舗詳細へ移動:', shopId);
    window.location.href = `{% url 'admin_panel:shop_detail' 0 %}`.replace('0', shopId);
}

// ユーザー詳細表示
function viewUser(userId) {
    console.log('ユーザー詳細へ移動:', userId);
    if (!userId) {
        showToast('ユーザー情報が見つかりません', 'error');
        return;
    }
    window.location.href = `{% url 'admin_panel:user_detail' 0 %}`.replace('0', userId);
}

// フィルター変更時の自動適用
document.addEventListener('DOMContentLoaded', function() {
    // 現在のページ番号を初期化
    const urlParams = new URLSearchParams(window.location.search);
    const pageParam = urlParams.get('page');
    if (pageParam && !isNaN(pageParam)) {
        currentPage = parseInt(pageParam);
    }
    
    const statusFilter = document.getElementById('statusFilter');
    const ratingFilter = document.getElementById('ratingFilter');
    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');
    
    if (statusFilter) statusFilter.addEventListener('change', applyFilters);
    if (ratingFilter) ratingFilter.addEventListener('change', applyFilters);
    if (sortSelect) sortSelect.addEventListener('change', applyFilters);
    
    // 検索フィールドでEnterキー押下時
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    }
    
    // レビューカードのイベントリスナーを追加（初期読み込み時とAjax読み込み時）
    setupReviewCardEvents();
    
    console.log('レビュー管理ページ初期化完了 - 現在のページ:', currentPage);
});

// レビューカードのイベントリスナーを設定する関数
function setupReviewCardEvents() {
    console.log('setupReviewCardEvents called');
    
    // 表示/非表示切り替えボタン
    const visibilityBtns = document.querySelectorAll('.toggle-visibility-btn');
    console.log('Found visibility buttons:', visibilityBtns.length);
    visibilityBtns.forEach(btn => {
        btn.removeEventListener('click', handleVisibilityToggle); // 重複防止
        btn.addEventListener('click', handleVisibilityToggle);
    });
    
    // 削除ボタン
    const deleteBtns = document.querySelectorAll('.delete-review-btn');
    console.log('Found delete buttons:', deleteBtns.length);
    deleteBtns.forEach(btn => {
        btn.removeEventListener('click', handleReviewDelete); // 重複防止
        btn.addEventListener('click', handleReviewDelete);
    });
    
    // レビュー内容展開/折りたたみ
    const toggleBtns = document.querySelectorAll('.toggle-content-btn');
    console.log('Found toggle buttons:', toggleBtns.length);
    toggleBtns.forEach(btn => {
        btn.removeEventListener('click', handleContentToggle); // 重複防止
        btn.addEventListener('click', handleContentToggle);
    });
    
    // 店舗詳細ボタン
    const shopBtns = document.querySelectorAll('.view-shop-btn');
    console.log('Found shop buttons:', shopBtns.length);
    shopBtns.forEach(btn => {
        btn.removeEventListener('click', handleViewShop); // 重複防止
        btn.addEventListener('click', handleViewShop);
    });
    
    // ユーザー詳細ボタン
    const userBtns = document.querySelectorAll('.view-user-btn');
    console.log('Found user buttons:', userBtns.length);
    userBtns.forEach(btn => {
        btn.removeEventListener('click', handleViewUser); // 重複防止
        btn.addEventListener('click', handleViewUser);
    });
}

// イベントハンドラー関数群
function handleVisibilityToggle(e) {
    console.log('handleVisibilityToggle called', e);
    e.preventDefault();
    e.stopPropagation();
    const reviewId = this.getAttribute('data-review-id');
    const currentVisible = this.getAttribute('data-visible') === 'true';
    console.log('Review ID:', reviewId, 'Current Visible:', currentVisible);
    // 現在の状態と逆にする（表示中なら非表示に、非表示なら表示に）
    toggleReviewVisibility(reviewId, !currentVisible);
}

function handleReviewDelete(e) {
    console.log('handleReviewDelete called', e);
    e.preventDefault();
    e.stopPropagation();
    const reviewId = this.getAttribute('data-review-id');
    console.log('Delete Review ID:', reviewId);
    deleteReview(reviewId);
}

function handleContentToggle(e) {
    console.log('handleContentToggle called', e);
    e.preventDefault();
    e.stopPropagation();
    const reviewId = this.getAttribute('data-review-id');
    toggleContent(reviewId);
}

function handleViewShop(e) {
    console.log('handleViewShop called', e);
    e.preventDefault();
    e.stopPropagation();
    const shopId = this.getAttribute('data-shop-id');
    console.log('ショップボタンクリック - Shop ID:', shopId);
    if (shopId) {
        viewShop(shopId);
    } else {
        showToast('店舗IDが見つかりません', 'error');
    }
}

function handleViewUser(e) {
    console.log('handleViewUser called', e);
    e.preventDefault();
    e.stopPropagation();
    const userId = this.getAttribute('data-user-id');
    console.log('ユーザーボタンクリック - User ID:', userId);
    if (userId && userId !== 'None') {
        viewUser(userId);
    } else {
        showToast('ユーザーIDが見つかりません', 'error');
    }
}

// 一括操作（将来の実装用）
function bulkApprove() {
    showToast('一括承認機能は実装予定です', 'info');
}

function bulkHide() {
    showToast('一括非表示機能は実装予定です', 'info');
}

function bulkDelete() {
    showToast('一括削除機能は実装予定です', 'info');
}

function clearSelection() {
    showToast('選択解除機能は実装予定です', 'info');
}
</script>
{% endblock %}
