{% extends 'admin_panel/base.html' %}

{% block title %}{{ shop.name }} - 店舗詳細 - 管理者パネル{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .star-rating {
        color: #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-store"></i> {{ shop.name }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'admin_panel:shop_edit' shop.pk %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-edit"></i> 編集
            </a>
            <a href="{% url 'admin_panel:shop_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> 戻る
            </a>
        </div>
    </div>
</div>

<!-- 基本情報 -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> 基本情報</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>店舗名</h6>
                        <p class="text-muted">{{ shop.name }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>電話番号</h6>
                        <p class="text-muted">{{ shop.phone_number|default:"未設定" }}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>住所</h6>
                        <p class="text-muted">{{ shop.address }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>席数</h6>
                        <p class="text-muted">{{ shop.seat_count }}席</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6>管理者</h6>
                        <p class="text-muted">
                            <a href="{% url 'admin_panel:user_detail' shop.user.pk %}" class="text-decoration-none">
                                {{ shop.user.email }}
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <!-- 統計情報 -->
        <div class="row">
            <div class="col-6 mb-3">
                <div class="card stat-card bg-primary text-white">
                    <div class="card-body text-center">
                        <div class="h4 mb-0">{{ total_reviews }}</div>
                        <small>レビュー数</small>
                    </div>
                </div>
            </div>
            <div class="col-6 mb-3">
                <div class="card stat-card bg-warning text-white">
                    <div class="card-body text-center">
                        <div class="h4 mb-0">{{ avg_rating|floatformat:1 }}</div>
                        <small>平均評価</small>
                    </div>
                </div>
            </div>
            <div class="col-6 mb-3">
                <div class="card stat-card bg-success text-white">
                    <div class="card-body text-center">
                        <div class="h4 mb-0">{{ total_reservations }}</div>
                        <small>予約数</small>
                    </div>
                </div>
            </div>
            <div class="col-6 mb-3">
                <div class="card stat-card bg-info text-white">
                    <div class="card-body text-center">
                        <div class="h4 mb-0">{{ total_favorites }}</div>
                        <small>お気に入り</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 最近のレビュー -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-star"></i> 最近のレビュー</h5>
                <a href="{% url 'admin_panel:review_list' %}?search={{ shop.name }}" class="btn btn-sm btn-outline-primary">
                    すべて表示
                </a>
            </div>
            <div class="card-body">
                {% if recent_reviews %}
                    {% for review in recent_reviews %}
                    <div class="d-flex justify-content-between mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <div class="star-rating me-2">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                            <i class="fas fa-star"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <small class="text-muted">{{ review.created_at|date:"Y/m/d" }}</small>
                            </div>
                            <div class="fw-bold small">{{ review.user.email|default:"匿名ユーザー" }}</div>
                            {% if review.comment %}
                            <p class="small text-muted mb-0">{{ review.comment|truncatechars:100 }}</p>
                            {% endif %}
                        </div>
                        <div class="ms-2">
                            {% if review.is_visible %}
                                <span class="badge bg-success">表示</span>
                            {% else %}
                                <span class="badge bg-secondary">非表示</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-star fa-2x mb-2"></i>
                        <p>まだレビューがありません</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 最近の予約 -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> 最近の予約</h5>
                <a href="{% url 'admin_panel:sales_list' %}?search={{ shop.name }}" class="btn btn-sm btn-outline-primary">
                    すべて表示
                </a>
            </div>
            <div class="card-body">
                {% if recent_reservations %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>予約日</th>
                                    <th>ユーザー</th>
                                    <th>人数</th>
                                    <th>登録日</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reservation in recent_reservations %}
                                <tr>
                                    <td>{{ reservation.date|date:"Y/m/d" }}</td>
                                    <td>
                                        <a href="{% url 'admin_panel:user_detail' reservation.user.pk %}" class="text-decoration-none small">
                                            {{ reservation.user.email|truncatechars:20 }}
                                        </a>
                                    </td>
                                    <td>{{ reservation.number_of_people }}名</td>
                                    <td>{{ reservation.created_at|date:"m/d" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                        <p>まだ予約がありません</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 画像一覧 -->
{% if shop.images.all %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-images"></i> 店舗画像</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for image in shop.images.all %}
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card">
                            <img src="{{ image.image.url }}" class="card-img-top" alt="店舗画像" style="height: 150px; object-fit: cover;">
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// 必要に応じてJavaScriptを追加
</script>
{% endblock %}
