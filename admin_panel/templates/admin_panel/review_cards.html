{% load static %}
<!-- レビューカード部分テンプレート -->
{% for review in reviews %}
<div class="col-lg-6 mb-4 review-card-item">
    <div class="card review-card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="star-rating me-2">
                    {% for i in "12345" %}
                        {% if forloop.counter <= review.rating %}
                            <i class="fas fa-star"></i>
                        {% else %}
                            <i class="far fa-star"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="fw-bold">{{ review.rating }}.0</span>
            </div>
            <div class="d-flex align-items-center">
                {% if review.is_visible %}
                    <span class="badge bg-success me-2">表示中</span>
                {% else %}
                    <span class="badge bg-secondary me-2">非表示</span>
                {% endif %}
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                    </button>
                    <ul class="dropdown-menu">
                        {% if review.is_visible %}
                            <li><a class="dropdown-item toggle-visibility-btn" href="#" data-review-id="{{ review.id }}" data-visible="false">
                                <i class="fas fa-eye-slash"></i> 非表示にする
                            </a></li>
                        {% else %}
                            <li><a class="dropdown-item toggle-visibility-btn" href="#" data-review-id="{{ review.id }}" data-visible="true">
                                <i class="fas fa-eye"></i> 表示する
                            </a></li>
                        {% endif %}
                        <li><a class="dropdown-item text-danger delete-review-btn" href="#" data-review-id="{{ review.id }}">
                            <i class="fas fa-trash"></i> 削除
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between mb-3">
                <div>
                    <h6 class="card-title mb-1">
                        <a href="{% url 'admin_panel:shop_detail' review.shop.id %}" class="text-decoration-none">
                            {{ review.shop.name }}
                        </a>
                    </h6>
                    <small class="text-muted">{{ review.shop.address }}</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold">{{ review.user.email|default:"匿名ユーザー" }}</div>
                    <small class="text-muted">{{ review.created_at|date:"Y/m/d H:i" }}</small>
                </div>
            </div>
            
            {% if review.comment %}
            <div class="review-content mb-3" id="content-{{ review.id }}">
                {{ review.comment|linebreaksbr }}
            </div>
            {% if review.comment|length > 150 %}
            <div class="review-toggle toggle-content-btn" data-review-id="{{ review.id }}">
                <span id="toggle-text-{{ review.id }}">もっと見る</span>
            </div>
            {% endif %}
            {% endif %}
        </div>
        <div class="card-footer bg-transparent">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    投稿から{{ review.created_at|timesince }}
                </small>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary view-shop-btn" 
                            data-shop-id="{{ review.shop.id }}" 
                            title="店舗詳細を表示">
                        <i class="fas fa-store"></i> ショップ
                    </button>
                    {% if review.user %}
                    <button class="btn btn-sm btn-outline-info view-user-btn" 
                            data-user-id="{{ review.user.id }}" 
                            title="ユーザー詳細を表示">
                        <i class="fas fa-user"></i> ユーザー
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-outline-secondary" disabled title="匿名ユーザー">
                        <i class="fas fa-user-slash"></i> 匿名
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% empty %}
<!-- 空の場合のメッセージは最初のロード時のみ表示 -->
{% endfor %}
