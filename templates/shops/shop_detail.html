{% extends 'base.html' %}

{% block content %}
<!-- CSRFトークンをページに含める -->
{% csrf_token %}

<div class="shop-detail-container">
    <!-- =================================== -->
    <!-- パンくずナビゲーション -->
    <!-- =================================== -->
    <nav class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="{% url 'shops:shop_list' %}" class="breadcrumb-item">
                <i data-feather="home"></i>
                <span>ホーム</span>
            </a>
            <i data-feather="chevron-right" class="breadcrumb-separator"></i>
            <a href="{% url 'shops:shop_list' %}" class="breadcrumb-item">
                <span>店舗一覧</span>
            </a>
            <i data-feather="chevron-right" class="breadcrumb-separator"></i>
            <span class="breadcrumb-current">{{ shop.name }}</span>
        </div>
    </nav>

    <!-- =================================== -->
    <!-- メインコンテンツ -->
    <!-- =================================== -->
    <div class="shop-main">
        <!-- =================================== -->
        <!-- 画像ギャラリー -->
        <!-- =================================== -->
        <div class="gallery-section">
            {% if shop.images.exists %}
                <div class="image-gallery">
                    <!-- メイン画像 -->
                    <div class="main-image-container">
                        <div class="main-image-wrapper">
                            <img id="mainImage" 
                                 src="{{ shop.images.first.image.url }}" 
                                 alt="{{ shop.name }}"
                                 class="main-image">
                            <div class="image-overlay">
                                <button class="zoom-btn" onclick="openLightbox(0)">
                                    <i data-feather="zoom-in"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 画像ナビゲーション -->
                        {% if shop.images.count > 1 %}
                            <div class="image-navigation">
                                <button class="nav-btn prev-btn" onclick="changeMainImage(-1)">
                                    <i data-feather="chevron-left"></i>
                                </button>
                                <span class="image-counter">
                                    <span id="currentImageIndex">1</span> / {{ shop.images.count }}
                                </span>
                                <button class="nav-btn next-btn" onclick="changeMainImage(1)">
                                    <i data-feather="chevron-right"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>

                    <!-- サムネイル -->
                    {% if shop.images.count > 1 %}
                        <div class="thumbnail-container">
                            <div class="thumbnail-grid" id="thumbnailGrid">
                                {% for image in shop.images.all %}
                                    <div class="thumbnail {% if forloop.first %}active{% endif %}" 
                                         data-index="{{ forloop.counter0 }}">
                                        <img src="{{ image.image.url }}" alt="{{ shop.name }}">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <div class="no-images">
                    <div class="no-image-icon">
                        <i data-feather="image"></i>
                    </div>
                    <p>画像準備中</p>
                </div>
            {% endif %}
        </div>

        <!-- =================================== -->
        <!-- 店舗情報 -->
        <!-- =================================== -->
        <div class="shop-info-section">
            <!-- ヘッダー -->
            <div class="shop-header">
                <div class="shop-title-area">
                    <h1 class="shop-name">{{ shop.name }}</h1>
                    <div class="shop-badges">
                        <span class="badge-new">
                            <i data-feather="star"></i>
                            おすすめ
                        </span>
                    </div>
                </div>
                
                <!-- アクションボタン -->
                <div class="action-buttons">
                    {% if user.is_authenticated %}
                        <button class="btn-favorite" 
                                data-shop-id="{{ shop.pk }}"
                                data-is-favorited="{{ is_favorited|yesno:'true,false' }}"
                                data-favorite-count="{{ favorite_count }}">
                            <i class="favorite-icon" data-feather="heart"></i>
                            <span class="favorite-text">お気に入り</span>
                        </button>
                    {% else %}
                        <a href="{% url 'accounts:login' %}" class="btn-favorite btn-login-required">
                            <i class="favorite-icon" data-feather="heart"></i>
                            <span class="favorite-text">お気に入り（要ログイン）</span>
                        </a>
                    {% endif %}
                    <button class="btn-share" data-shop-id="{{ shop.pk }}">
                        <i data-feather="share-2"></i>
                        <span>共有</span>
                    </button>
                </div>
            </div>

            <!-- 基本情報 -->
            <div class="shop-details">
                <div class="detail-card">
                    <h3 class="card-title">
                        <i data-feather="info"></i>
                        基本情報
                    </h3>
                    <div class="detail-grid">
                        <div class="detail-row">
                            <div class="detail-label">
                                <i data-feather="map-pin"></i>
                                <span>住所</span>
                            </div>
                            <div class="detail-value">{{ shop.address }}</div>
                        </div>
                        
                        <div class="detail-row">
                            <div class="detail-label">
                                <i data-feather="phone"></i>
                                <span>電話番号</span>
                            </div>
                            <div class="detail-value">
                                {% if shop.phone_number %}
                                    <a href="tel:{{ shop.phone_number }}" class="phone-link">
                                        {{ shop.phone_number }}
                                    </a>
                                {% else %}
                                    お問い合わせ時間をご確認ください
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="detail-row">
                            <div class="detail-label">
                                <i data-feather="users"></i>
                                <span>座席数</span>
                            </div>
                            <div class="detail-value">{{ shop.seat_count }}席</div>
                        </div>
                        
                        {% if shop.images.count > 0 %}
                            <div class="detail-row">
                                <div class="detail-label">
                                    <i data-feather="camera"></i>
                                    <span>写真</span>
                                </div>
                                <div class="detail-value">{{ shop.images.count }}枚</div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- レビューセクション（将来的な拡張） -->
                <div class="detail-card">
                    <h3 class="card-title">
                        <i data-feather="message-square"></i>
                        レビュー
                    </h3>
                    <div class="review-section">
                        <!-- 平均評価 -->
                        <div class="review-stats">
                            <div class="star-rating">
                                <div class="stars">
                                    {% for i in "12345" %}
                                        <i data-feather="star" class="star {% if forloop.counter <= avg_rating_int %}filled{% endif %}"></i>
                                    {% endfor %}
                                </div>
                                <span class="rating-text">{{ avg_rating }} / 5 ・ {{ review_count }}件</span>
                            </div>
                        </div>

                        <!-- 最近のレビュー（最大3件） -->
                        <div class="recent-reviews">
                            {% if reviews %}
                                <ul class="review-list">
                                    {% for review in reviews|slice:":3" %}
                                        <li class="review-item">
                                            <div class="review-item-header">
                                                <div class="review-item-stars">
                                                    {% for i in "12345" %}
                                                        <i data-feather="star" class="star {% if forloop.counter <= review.rating %}filled{% endif %}"></i>
                                                    {% endfor %}
                                                </div>
                                                <div class="review-item-meta">
                                                    <span class="review-user">{{ review.user.email }}</span>
                                                    <span class="review-date">{{ review.created_at|date:"Y-m-d H:i" }}</span>
                                                </div>
                                            </div>
                                            {% if review.comment %}
                                                <p class="review-comment">{{ review.comment|linebreaksbr }}</p>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="no-reviews">まだレビューはありません。</p>
                            {% endif %}
                        </div>

                        <!-- アクション -->
                        <div class="review-actions-group">
                            {% if user.is_authenticated and is_subscriber %}
                                <button class="btn-review">
                                    <i data-feather="edit"></i>
                                    レビューを書く
                                </button>
                            {% elif user.is_authenticated and not is_subscriber %}
                                <div class="login-required">
                                    <span>レビュー投稿は有料会員限定です。</span>
                                    <a href="{% url 'accounts:mypage' %}?subscribe_required=1&next={{ request.path|urlencode }}">マイページで契約する</a>
                                </div>
                            {% else %}
                                <p class="login-required">
                                    <a href="{% url 'accounts:login' %}">ログイン</a>してレビューを投稿
                                </p>
                            {% endif %}
                            <a href="{% url 'shops:shop_review_list' shop.pk %}" class="btn-view-reviews">
                                <i data-feather="message-square"></i>
                                レビュー一覧を見る
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =================================== -->
    <!-- ライトボックス（画像拡大表示） -->
    <!-- =================================== -->
    <div id="lightbox" class="lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" onclick="closeLightbox()">
                <i data-feather="x"></i>
            </button>
            <div class="lightbox-image-container">
                <img id="lightboxImage" src="" alt="">
                {% if shop.images.count > 1 %}
                    <button class="lightbox-nav prev" onclick="lightboxNav(-1)">
                        <i data-feather="chevron-left"></i>
                    </button>
                    <button class="lightbox-nav next" onclick="lightboxNav(1)">
                        <i data-feather="chevron-right"></i>
                    </button>
                {% endif %}
            </div>
            <div class="lightbox-info">
                <p id="lightboxImageInfo">{{ shop.name }}</p>
            </div>
        </div>
    </div>

    <!-- =================================== -->
    <!-- レビュー入力モーダル -->
    <!-- =================================== -->
    <div id="reviewModal" class="review-modal">
        <div class="review-modal-content">
            <div class="review-modal-header">
                <h3 class="modal-title">
                    <i data-feather="edit"></i>
                    レビューを投稿
                </h3>
                <button class="modal-close" onclick="closeReviewModal()">
                    <i data-feather="x"></i>
                </button>
            </div>

            <div class="review-modal-body">
                <!-- 店舗情報表示 -->
                <div class="review-shop-info">
                    <div class="shop-info-card">
                        {% if shop.images.exists %}
                            <img src="{{ shop.images.first.image.url }}" alt="{{ shop.name }}" class="shop-thumb">
                        {% else %}
                            <div class="shop-thumb-placeholder">
                                <i data-feather="image"></i>
                            </div>
                        {% endif %}
                        <div class="shop-info-text">
                            <h4 class="shop-name-small">{{ shop.name }}</h4>
                            <p class="shop-address-small">{{ shop.address }}</p>
                        </div>
                    </div>
                </div>

                <!-- レビューフォーム -->
                <form id="reviewForm" class="review-form">
                    {% csrf_token %}
                    <input type="hidden" name="shop_id" value="{{ shop.pk }}">
                    
                    <!-- 評価選択 -->
                    <div class="form-group">
                        <label class="form-label">
                            <i data-feather="star"></i>
                            評価（必須）
                        </label>
                        <div class="rating-input">
                            <div class="star-rating-input">
                                <input type="radio" name="rating" value="5" id="star5" required>
                                <label for="star5" class="star-label">
                                    <i data-feather="star"></i>
                                </label>
                                
                                <input type="radio" name="rating" value="4" id="star4">
                                <label for="star4" class="star-label">
                                    <i data-feather="star"></i>
                                </label>
                                
                                <input type="radio" name="rating" value="3" id="star3">
                                <label for="star3" class="star-label">
                                    <i data-feather="star"></i>
                                </label>
                                
                                <input type="radio" name="rating" value="2" id="star2">
                                <label for="star2" class="star-label">
                                    <i data-feather="star"></i>
                                </label>
                                
                                <input type="radio" name="rating" value="1" id="star1">
                                <label for="star1" class="star-label">
                                    <i data-feather="star"></i>
                                </label>
                            </div>
                            <div class="rating-text">
                                <span id="ratingText">評価を選択してください</span>
                            </div>
                        </div>
                    </div>

                    <!-- コメント入力 -->
                    <div class="form-group">
                        <label for="reviewComment" class="form-label">
                            <i data-feather="message-square"></i>
                            コメント（任意）
                        </label>
                        <textarea 
                            id="reviewComment" 
                            name="comment" 
                            class="review-textarea"
                            placeholder="お店の雰囲気、料理、サービスなどについて詳しく教えてください..."
                            rows="5"
                            maxlength="1000"></textarea>
                        <div class="character-count">
                            <span id="charCount">0</span>/1000文字
                        </div>
                    </div>

                    <!-- 投稿ガイドライン -->
                    <div class="review-guidelines">
                        <h5 class="guidelines-title">
                            <i data-feather="info"></i>
                            レビュー投稿ガイドライン
                        </h5>
                        <ul class="guidelines-list">
                            <li>実際に利用した体験に基づいてレビューしてください</li>
                            <li>他の利用者の参考になる具体的な情報を含めてください</li>
                            <li>誹謗中傷や不適切な表現は控えてください</li>
                            <li>個人情報の記載は避けてください</li>
                        </ul>
                    </div>
                </form>
            </div>

            <div class="review-modal-footer">
                <button type="button" class="btn-cancel" onclick="closeReviewModal()">
                    <i data-feather="x"></i>
                    キャンセル
                </button>
                <button type="submit" form="reviewForm" class="btn-submit" id="submitReviewBtn">
                    <i data-feather="send"></i>
                    レビューを投稿
                </button>
            </div>
        </div>
    </div>
</div>

<!-- =================================== -->
<!-- ショップ詳細ページ専用CSS -->
<!-- =================================== -->
<style>
/* =================================== */
/* 基本レイアウト */
/* =================================== */
.shop-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

/* =================================== */
/* パンくずナビゲーション */
/* =================================== */
.breadcrumb {
    margin-bottom: 2rem;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    color: var(--gray-600);
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.3s ease;
}

.breadcrumb-item:hover {
    color: var(--primary);
}

.breadcrumb-item i {
    width: 1rem;
    height: 1rem;
}

.breadcrumb-separator {
    width: 1rem;
    height: 1rem;
    color: var(--gray-400);
}

.breadcrumb-current {
    color: var(--gray-800);
    font-weight: 600;
    font-size: 0.875rem;
}

/* =================================== */
/* メインレイアウト */
/* =================================== */
.shop-main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    align-items: start;
}

/* =================================== */
/* 画像ギャラリー */
/* =================================== */
.gallery-section {
    position: sticky;
    top: 2rem;
}

.image-gallery {
    background: white;
    border-radius: 1.5rem;
    overflow: hidden;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.main-image-container {
    position: relative;
}

.main-image-wrapper {
    position: relative;
    aspect-ratio: 16/10;
    overflow: hidden;
}

.main-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.main-image-wrapper:hover .main-image {
    transform: scale(1.05);
}

.image-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.main-image-wrapper:hover .image-overlay {
    opacity: 1;
}

.zoom-btn {
    width: 4rem;
    height: 4rem;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    color: var(--gray-700);
    cursor: pointer;
    transition: all 0.3s ease;
}

.zoom-btn:hover {
    background: white;
    transform: scale(1.1);
}

.zoom-btn i {
    width: 1.5rem;
    height: 1.5rem;
}

.image-navigation {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
}

.nav-btn {
    width: 2.5rem;
    height: 2.5rem;
    background: var(--gray-100);
    border: 1px solid var(--gray-300);
    border-radius: 50%;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.nav-btn i {
    width: 1.25rem;
    height: 1.25rem;
}

.image-counter {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
}

.thumbnail-container {
    padding: 1rem;
    background: var(--gray-50);
}

.thumbnail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 0.75rem;
}

.thumbnail {
    aspect-ratio: 1;
    border-radius: 0.5rem;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.thumbnail.active {
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
}

.thumbnail:hover {
    transform: scale(1.05);
}

.thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.no-images {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    background: var(--gray-50);
    border-radius: 1.5rem;
    border: 2px dashed var(--gray-300);
}

.no-image-icon {
    width: 4rem;
    height: 4rem;
    background: var(--gray-200);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    color: var(--gray-500);
}

.no-image-icon i {
    width: 2rem;
    height: 2rem;
}

/* =================================== */
/* 店舗情報セクション */
/* =================================== */
.shop-info-section {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.shop-header {
    background: white;
    border-radius: 1.5rem;
    padding: 2rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.shop-title-area {
    margin-bottom: 1.5rem;
}

.shop-name {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--gray-800);
    margin: 0 0 1rem 0;
    line-height: 1.2;
}

.shop-badges {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.badge-new {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 600;
}

.badge-new i {
    width: 1rem;
    height: 1rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
}

.btn-favorite,
.btn-share {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    border: 2px solid var(--gray-300);
    border-radius: 1rem;
    background: white;
    color: var(--gray-700);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-favorite:hover {
    background: #fef2f2;
    border-color: #fca5a5;
    color: #dc2626;
}

.btn-share:hover {
    background: #eff6ff;
    border-color: #93c5fd;
    color: #2563eb;
}

.btn-favorite i,
.btn-share i {
    width: 1.25rem;
    height: 1.25rem;
}

.shop-details {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.detail-card {
    background: white;
    border-radius: 1.5rem;
    padding: 2rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.card-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-800);
    margin: 0 0 1.5rem 0;
}

.card-title i {
    width: 1.5rem;
    height: 1.5rem;
    color: var(--primary);
}

.detail-grid {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
}

.detail-row {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.detail-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 120px;
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.875rem;
}

.detail-label i {
    width: 1rem;
    height: 1rem;
    color: var(--primary);
}

.detail-value {
    flex: 1;
    color: var(--gray-600);
    line-height: 1.5;
}

.phone-link {
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
}

.phone-link:hover {
    text-decoration: underline;
}

/* =================================== */
/* レビューのプレースホルダー */
/* =================================== */
.review-placeholder {
    text-align: center;
    padding: 2rem;
    background: var(--gray-50);
    border-radius: 1rem;
    border: 2px dashed var(--gray-300);
}

.btn-review {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    margin-right: 1rem;
}

.btn-review:hover {
    background: var(--primary-dark);
}

.btn-view-reviews {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--gray-100);
    color: var(--gray-700);
    text-decoration: none;
    border-radius: 0.75rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-view-reviews:hover {
    background: var(--gray-200);
    color: var(--gray-800);
}

.review-actions-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    margin-top: 1rem;
}

.review-stats {
    margin-bottom: 1rem;
}

.star-rating {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.stars {
    display: flex;
    gap: 0.25rem;
}

.star {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--gray-300);
}

.star.filled {
    color: #fbbf24;
}

.rating-text {
    font-weight: 600;
    color: var(--gray-700);
}

.login-required {
    margin-top: 1rem;
    text-align: center;
    color: var(--gray-600);
    font-size: 0.875rem;
}

.login-required a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
}

.login-required a:hover {
    text-decoration: underline;
}

/* =================================== */
/* ライトボックス */
/* =================================== */
.lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
}

.lightbox.active {
    display: flex;
}

.lightbox-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.lightbox-close {
    position: absolute;
    top: -50px;
    right: 0;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
    z-index: 1001;
}

.lightbox-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

.lightbox-close i {
    width: 1.5rem;
    height: 1.5rem;
}

.lightbox-image-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

#lightboxImage {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
    border-radius: 0.5rem;
}

.lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
}

.lightbox-nav:hover {
    background: rgba(0, 0, 0, 0.7);
}

.lightbox-nav.prev {
    left: -60px;
}

.lightbox-nav.next {
    right: -60px;
}

.lightbox-nav i {
    width: 1.5rem;
    height: 1.5rem;
}

.lightbox-info {
    text-align: center;
    margin-top: 1rem;
}

.lightbox-info p {
    color: white;
    font-weight: 500;
    margin: 0;
}

/* =================================== */
/* レビュー入力モーダル */
/* =================================== */
.review-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.review-modal.active {
    display: flex;
}

.review-modal-content {
    background: white;
    border-radius: 1.5rem;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.review-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 2rem 2rem 0 2rem;
    border-bottom: 1px solid var(--gray-200);
    margin-bottom: 1.5rem;
}

.modal-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-800);
    margin: 0;
}

.modal-title i {
    width: 1.5rem;
    height: 1.5rem;
    color: var(--primary);
}

.modal-close {
    width: 2.5rem;
    height: 2.5rem;
    background: var(--gray-100);
    border: 1px solid var(--gray-300);
    border-radius: 50%;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: var(--gray-200);
    color: var(--gray-800);
}

.modal-close i {
    width: 1.25rem;
    height: 1.25rem;
}

.review-modal-body {
    flex: 1;
    padding: 0 2rem;
    overflow-y: auto;
}

.review-shop-info {
    margin-bottom: 2rem;
}

.shop-info-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: 1rem;
    border: 1px solid var(--gray-200);
}

.shop-thumb {
    width: 60px;
    height: 60px;
    border-radius: 0.75rem;
    object-fit: cover;
}

.shop-thumb-placeholder {
    width: 60px;
    height: 60px;
    background: var(--gray-200);
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-500);
}

.shop-thumb-placeholder i {
    width: 1.5rem;
    height: 1.5rem;
}

.shop-info-text {
    flex: 1;
}

.shop-name-small {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-800);
    margin: 0 0 0.25rem 0;
}

.shop-address-small {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin: 0;
}

.review-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.form-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.875rem;
}

.form-label i {
    width: 1rem;
    height: 1rem;
    color: var(--primary);
}

.rating-input {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.star-rating-input {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 0.25rem;
}

.star-rating-input input[type="radio"] {
    display: none;
}

.star-label {
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0.25rem;
    border-radius: 0.375rem;
}

.star-label i {
    width: 2rem;
    height: 2rem;
    color: var(--gray-300);
    transition: color 0.3s ease;
}

.star-label:hover i {
    color: #fbbf24;
}

.star-rating-input input[type="radio"]:checked ~ .star-label i,
.star-rating-input .star-label:hover ~ .star-label i {
    color: #fbbf24;
}

.star-rating-input input[type="radio"]:checked + .star-label i {
    color: #fbbf24;
}

.rating-text {
    font-size: 0.875rem;
    color: var(--gray-600);
    text-align: center;
    padding: 0.5rem;
    background: var(--gray-50);
    border-radius: 0.5rem;
}

.review-textarea {
    width: 100%;
    padding: 1rem;
    border: 2px solid var(--gray-300);
    border-radius: 0.75rem;
    font-size: 0.875rem;
    line-height: 1.5;
    resize: vertical;
    min-height: 120px;
    transition: border-color 0.3s ease;
    font-family: inherit;
}

.review-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.review-textarea::placeholder {
    color: var(--gray-500);
}

.character-count {
    text-align: right;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.review-guidelines {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: 0.75rem;
    padding: 1.25rem;
}

.guidelines-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
    margin: 0 0 0.75rem 0;
}

.guidelines-title i {
    width: 1rem;
    height: 1rem;
    color: var(--primary);
}

.guidelines-list {
    margin: 0;
    padding-left: 1.25rem;
    list-style-type: disc;
}

.guidelines-list li {
    font-size: 0.75rem;
    color: var(--gray-600);
    margin-bottom: 0.375rem;
    line-height: 1.4;
}

.guidelines-list li:last-child {
    margin-bottom: 0;
}

.review-modal-footer {
    display: flex;
    gap: 1rem;
    padding: 1.5rem 2rem 2rem 2rem;
    border-top: 1px solid var(--gray-200);
    margin-top: 1.5rem;
}

.btn-cancel,
.btn-submit {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
}

.btn-cancel {
    background: var(--gray-100);
    border: 1px solid var(--gray-300);
    color: var(--gray-700);
}

.btn-cancel:hover {
    background: var(--gray-200);
    color: var(--gray-800);
}

.btn-submit {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border: 1px solid transparent;
    color: white;
}

.btn-submit:hover {
    background: linear-gradient(135deg, var(--primary-dark), #4c1d95);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
}

.btn-submit:disabled {
    background: var(--gray-300);
    color: var(--gray-500);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-cancel i,
.btn-submit i {
    width: 1rem;
    height: 1rem;
}

/* =================================== */
/* レスポンシブデザイン */
/* =================================== */
@media (max-width: 1024px) {
    .shop-main {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    .gallery-section {
        position: relative;
        top: auto;
    }
}

@media (max-width: 768px) {
    .shop-detail-container {
        padding: 1rem;
    }
    
    .shop-name {
        font-size: 2rem;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .detail-row {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .detail-label {
        min-width: auto;
    }
    
    .thumbnail-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    }
    
    .lightbox-nav.prev {
        left: 10px;
    }
    
    .lightbox-nav.next {
        right: 10px;
    }
}

@media (max-width: 480px) {
    .shop-header,
    .detail-card {
        padding: 1.5rem;
    }
    
    .breadcrumb-content {
        font-size: 0.75rem;
    }
    
    .shop-name {
        font-size: 1.75rem;
    }
}
</style>

<script id="shop-images-data" type="application/json">
[
{% for image in shop.images.all %}
    {"url": "{{ image.image.url }}", "alt": "{{ shop.name }} - 画像{{ forloop.counter }}"}{% if not forloop.last %},{% endif %}
{% endfor %}
]
</script>

<script>
// 画像データを格納（JSON script から安全に読み込み）
let shopImages = [];
try {
        shopImages = JSON.parse(document.getElementById('shop-images-data')?.textContent || '[]');
} catch(e) {
        console.error('Failed to parse shop images json:', e);
        shopImages = [];
}

let currentImageIndex = 0;

// Feather Icons初期化
feather.replace();

// 有料会員フラグ: 後段のPAGE_FLAGSで定義されます

// 画像ギャラリー機能
function changeMainImage(direction) {
    if (shopImages.length === 0) return;
    
    currentImageIndex += direction;
    
    if (currentImageIndex >= shopImages.length) {
        currentImageIndex = 0;
    } else if (currentImageIndex < 0) {
        currentImageIndex = shopImages.length - 1;
    }
    
    updateMainImage();
}

function selectImage(index) {
    if (index >= 0 && index < shopImages.length) {
        currentImageIndex = index;
        updateMainImage();
    }
}

function updateMainImage() {
    const mainImage = document.getElementById('mainImage');
    const currentIndexEl = document.getElementById('currentImageIndex');
    
    if (mainImage && shopImages[currentImageIndex]) {
        mainImage.src = shopImages[currentImageIndex].url;
        mainImage.alt = shopImages[currentImageIndex].alt;
    }
    
    if (currentIndexEl) {
        currentIndexEl.textContent = currentImageIndex + 1;
    }
    
    // サムネイルのアクティブ状態更新
    document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
        thumb.classList.toggle('active', index === currentImageIndex);
    });
}

// ライトボックス機能
function openLightbox(index) {
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    
    if (shopImages[index]) {
        currentImageIndex = index;
        lightboxImage.src = shopImages[index].url;
        lightboxImage.alt = shopImages[index].alt;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    lightbox.classList.remove('active');
    document.body.style.overflow = 'auto';
}

function lightboxNav(direction) {
    currentImageIndex += direction;
    
    if (currentImageIndex >= shopImages.length) {
        currentImageIndex = 0;
    } else if (currentImageIndex < 0) {
        currentImageIndex = shopImages.length - 1;
    }
    
    const lightboxImage = document.getElementById('lightboxImage');
    lightboxImage.src = shopImages[currentImageIndex].url;
    lightboxImage.alt = shopImages[currentImageIndex].alt;
}

// キーボードショートカット
document.addEventListener('keydown', function(e) {
    const lightbox = document.getElementById('lightbox');
    
    if (lightbox.classList.contains('active')) {
        switch(e.key) {
            case 'Escape':
                closeLightbox();
                break;
            case 'ArrowLeft':
                lightboxNav(-1);
                break;
            case 'ArrowRight':
                lightboxNav(1);
                break;
        }
    }
});

// ライトボックス外クリックで閉じる
document.getElementById('lightbox').addEventListener('click', function(e) {
    if (e.target === this) {
        closeLightbox();
    }
});

// お気に入り・共有ボタンの機能
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing favorite button...');
    
    // お気に入りボタン
    const favoriteBtn = document.querySelector('.btn-favorite:not(.btn-login-required)');
    console.log('Favorite button found:', favoriteBtn);
    
    if (favoriteBtn) {
        const shopId = favoriteBtn.dataset.shopId;
        console.log('Shop ID:', shopId);
        
        // 初期状態を設定（データ属性から取得）
        const isFavorited = favoriteBtn.dataset.isFavorited === 'true';
        const favoriteCount = parseInt(favoriteBtn.dataset.favoriteCount) || 0;
        console.log('Initial state - isFavorited:', isFavorited, 'favoriteCount:', favoriteCount);
        
        updateFavoriteButton(isFavorited, favoriteCount);
        
        favoriteBtn.addEventListener('click', function() {
            console.log('Favorite button clicked!');
            toggleFavorite(shopId);
        });
    }
    
    // 共有ボタン
    const shareBtn = document.querySelector('.btn-share');
    if (shareBtn) {
        shareBtn.addEventListener('click', function() {
            if (navigator.share) {
                navigator.share({
                    title: '{{ shop.name }} - NAGOYAMESHI',
                    text: '{{ shop.name }}をチェックしてみてください！',
                    url: window.location.href
                });
            } else {
                // フォールバック
                navigator.clipboard.writeText(window.location.href);
                alert('URLをコピーしました！');
            }
        });
    }
    
    // レビューボタン
    const reviewBtn = document.querySelector('.btn-review');
    if (reviewBtn) {
        reviewBtn.addEventListener('click', function() {
            if (!IS_SUBSCRIBER) {
                // 念のためのガード（通常はボタン自体が表示されない）
                window.location.href = MYPAGE_URL + '?subscribe_required=1&next=' + CURRENT_PATH;
                return;
            }
            openReviewModal();
        });
    }

    // レビューフォームの処理
    initializeReviewForm();

    // サムネイルクリックでメイン画像を変更（inline onclickを廃止）
    const thumbs = document.querySelectorAll('.thumbnail');
    thumbs.forEach((thumb) => {
        thumb.addEventListener('click', () => {
            const idx = parseInt(thumb.getAttribute('data-index'));
            if (!isNaN(idx)) {
                selectImage(idx);
            }
        });
    });
});

// =================================== //
// レビューモーダル関連の関数
// =================================== //

function openReviewModal() {
    const modal = document.getElementById('reviewModal');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // フォームをリセット
    document.getElementById('reviewForm').reset();
    updateRatingText();
    updateCharacterCount();
    updateSubmitButton();
}

function closeReviewModal() {
    const modal = document.getElementById('reviewModal');
    modal.classList.remove('active');
    document.body.style.overflow = 'auto';
}

function initializeReviewForm() {
    const form = document.getElementById('reviewForm');
    const ratingInputs = document.querySelectorAll('input[name="rating"]');
    const commentTextarea = document.getElementById('reviewComment');
    
    // 評価選択の処理
    ratingInputs.forEach(input => {
        input.addEventListener('change', updateRatingText);
    });
    
    // コメント文字数カウント
    if (commentTextarea) {
        commentTextarea.addEventListener('input', updateCharacterCount);
    }
    
    // フォーム送信処理
    if (form) {
        form.addEventListener('submit', handleReviewSubmit);
    }
    
    // モーダル外クリックで閉じる
    document.getElementById('reviewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReviewModal();
        }
    });
    
    // ESCキーで閉じる
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('reviewModal');
            if (modal.classList.contains('active')) {
                closeReviewModal();
            }
        }
    });
}

function updateRatingText() {
    const selectedRating = document.querySelector('input[name="rating"]:checked');
    const ratingText = document.getElementById('ratingText');
    
    if (selectedRating) {
        const rating = parseInt(selectedRating.value);
        const ratingTexts = {
            5: '⭐⭐⭐⭐⭐ 最高！素晴らしいお店です',
            4: '⭐⭐⭐⭐ とても良い！おすすめです',
            3: '⭐⭐⭐ 普通です',
            2: '⭐⭐ いまいちでした',
            1: '⭐ 残念でした'
        };
        ratingText.textContent = ratingTexts[rating] || '評価を選択してください';
    } else {
        ratingText.textContent = '評価を選択してください';
    }
    
    updateSubmitButton();
}

function updateCharacterCount() {
    const textarea = document.getElementById('reviewComment');
    const charCount = document.getElementById('charCount');
    
    if (textarea && charCount) {
        const count = textarea.value.length;
        charCount.textContent = count;
        
        // 文字数に応じて色を変更
        if (count > 900) {
            charCount.style.color = '#dc2626'; // 赤
        } else if (count > 800) {
            charCount.style.color = '#f59e0b'; // オレンジ
        } else {
            charCount.style.color = '#6b7280'; // グレー
        }
    }
}

function updateSubmitButton() {
    const submitBtn = document.getElementById('submitReviewBtn');
    const selectedRating = document.querySelector('input[name="rating"]:checked');
    
    if (submitBtn) {
        if (selectedRating) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }
}

function handleReviewSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const rating = formData.get('rating');
    const comment = formData.get('comment');
    const shopId = formData.get('shop_id');
    
    // バリデーション
    if (!rating) {
        alert('評価を選択してください。');
        return;
    }
    
    // 送信ボタンを無効化
    const submitBtn = document.getElementById('submitReviewBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i data-feather="loader"></i>投稿中...';
    
    // CSRFトークンの取得
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // 実際のAPI送信処理
    fetch('{% url "shops:submit_review" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: new URLSearchParams({
            'shop_id': shopId,
            'rating': rating,
            'comment': comment
        })
    })
    .then(response => response.text().then(text => { try { return JSON.parse(text); } catch { return { success: false, message: 'サーバー応答の解析に失敗しました', raw: text }; } }))
    .then(data => {
        if (data.redirect_url) {
            window.location.href = data.redirect_url;
            return;
        }
        if (data.success) {
            alert(`レビューが投稿されました！\n評価: ${rating}つ星\nコメント: ${comment || '(コメントなし)'}`);
            closeReviewModal();
            
            // ページをリロードして最新の情報を表示
            window.location.reload();
        } else {
            alert('エラー: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ネットワークエラーが発生しました。');
    })
    .finally(() => {
        // ボタンを元に戻す
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        feather.replace();
    });
}

// =================================== //
// お気に入り機能
// =================================== //

// お気に入りリクエストの状態管理
let favoriteRequestInProgress = false;

function toggleFavorite(shopId) {
    console.log('toggleFavorite called with shopId:', shopId);
    
    // 既にリクエスト中の場合は処理を中断
    if (favoriteRequestInProgress) {
        console.log('Favorite request already in progress, skipping...');
        return;
    }
    
    // ログイン状態の確認
    if (!IS_AUTHENTICATED) {
        alert('お気に入り機能を使用するにはログインが必要です。');
        window.location.href = LOGIN_URL;
        return;
    }
    
    const favoriteBtn = document.querySelector('.btn-favorite:not(.btn-login-required)');
    if (!favoriteBtn) {
        console.log('Favorite button not found');
        return;
    }
    
    // リクエスト開始フラグを設定
    favoriteRequestInProgress = true;
    
    // ボタンを無効化
    favoriteBtn.disabled = true;
    favoriteBtn.style.opacity = '0.6';
    favoriteBtn.style.cursor = 'not-allowed';
    
    // アニメーション効果
    favoriteBtn.style.transform = 'scale(0.95)';
    setTimeout(() => {
        favoriteBtn.style.transform = 'scale(1)';
    }, 150);
    
    // CSRFトークンの取得（複数の方法を試す）
    let csrfToken = null;
    
    // 方法1: input要素から取得
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        csrfToken = csrfInput.value;
        console.log('CSRF token from input:', csrfToken);
    }
    
    // 方法2: metaタグから取得（フォールバック）
    if (!csrfToken) {
        const csrfMeta = document.querySelector('meta[name=csrf-token]');
        if (csrfMeta) {
            csrfToken = csrfMeta.getAttribute('content');
            console.log('CSRF token from meta:', csrfToken);
        }
    }
    
    // 方法3: Cookieから取得（フォールバック）
    if (!csrfToken) {
        // Django標準のCSRF Cookieの取得関数
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        csrfToken = getCookie('csrftoken');
        if (csrfToken) {
            console.log('CSRF token from cookie:', csrfToken);
        }
    }
    
    // デバッグ: 全てのCSRFトークン要素を検索
    console.log('All CSRF input elements:', document.querySelectorAll('[name=csrfmiddlewaretoken]'));
    console.log('All meta csrf elements:', document.querySelectorAll('meta[name=csrf-token]'));
    console.log('Document cookies:', document.cookie);
    
    console.log('CSRF token found:', csrfToken ? 'Yes' : 'No');
    console.log('CSRF token value:', csrfToken);
    
    if (!csrfToken) {
        alert('CSRFトークンが見つかりません。ページを再読み込みしてください。');
        return;
    }
    
    const url = `${window.location.protocol}//${window.location.host}/shops/favorite/toggle/${shopId}/`;
    console.log('Making request to:', url);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // レスポンスの内容をテキストとして取得してログ出力し、堅牢にJSON化
        return response.text().then(text => {
            console.log('Raw response text:', text);
            try {
                return JSON.parse(text);
            } catch (parseError) {
                console.error('JSON parse error:', parseError);
                console.error('Response text that failed to parse:', text);
                return { success: false, message: 'サーバーからの応答をJSONとして解析できませんでした。', raw: text };
            }
        });
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.redirect_url) {
            window.location.href = data.redirect_url;
            return;
        }
        if (data.success) {
            updateFavoriteButton(data.is_favorited, data.favorite_count);
            // 小さなフィードバック表示
            showToast(data.message);
        } else {
            console.error('API Error:', data.message);
            alert('API Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error details:', error);
        alert('サーバーエラー: ' + error.message);
    })
    .finally(() => {
        // リクエスト完了フラグを解除
        favoriteRequestInProgress = false;
        
        // ボタンを再有効化
        const favoriteBtn = document.querySelector('.btn-favorite:not(.btn-login-required)');
        if (favoriteBtn) {
            favoriteBtn.disabled = false;
            favoriteBtn.style.opacity = '1';
            favoriteBtn.style.cursor = 'pointer';
        }
        
        console.log('Favorite request completed');
    });
}

function updateFavoriteButton(isFavorited, favoriteCount) {
    console.log('updateFavoriteButton called with:', isFavorited, favoriteCount);
    
    const favoriteBtn = document.querySelector('.btn-favorite:not(.btn-login-required)');
    if (!favoriteBtn) {
        console.log('No favorite button found or user not logged in');
        return;
    }
    
    const icon = favoriteBtn.querySelector('.favorite-icon');
    const text = favoriteBtn.querySelector('.favorite-text');
    
    if (!icon) {
        console.error('Icon element not found in button:', favoriteBtn);
        return;
    }
    
    if (!text) {
        console.error('Text element not found in button:', favoriteBtn);
        return;
    }
    
    if (isFavorited) {
        favoriteBtn.classList.add('favorited');
        icon.setAttribute('data-feather', 'heart');
        text.textContent = `お気に入り済み (${favoriteCount})`;
        console.log('Button updated to favorited state');
    } else {
        favoriteBtn.classList.remove('favorited');
        icon.setAttribute('data-feather', 'heart');
        text.textContent = `お気に入り (${favoriteCount})`;
        console.log('Button updated to not favorited state');
    }
    
    // Featherアイコンを再描画
    try {
        feather.replace();
        console.log('Feather icons replaced successfully');
    } catch (featherError) {
        console.error('Feather replace error:', featherError);
    }
}

function showToast(message) {
    // 簡単なトースト通知
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}
// ページ状態フラグ（JSON）
</script>
<script id="page-flags" type="application/json">
{
  "isSubscriber": "{{ is_subscriber|yesno:'true,false' }}",
  "isAuthenticated": "{{ user.is_authenticated|yesno:'true,false' }}",
  "loginUrl": "{% url 'accounts:login' %}",
  "mypageUrl": "{% url 'accounts:mypage' %}",
  "currentPath": "{{ request.path|urlencode }}"
}
</script>
<script>
// ページフラグ読み込み
let PAGE_FLAGS = {};
try {
    PAGE_FLAGS = JSON.parse(document.getElementById('page-flags')?.textContent || '{}');
} catch(e) {
    console.error('Failed to parse page flags json:', e);
    PAGE_FLAGS = {};
}

// フラグ・URLの定義
const IS_SUBSCRIBER = String(PAGE_FLAGS.isSubscriber) === 'true';
const IS_AUTHENTICATED = String(PAGE_FLAGS.isAuthenticated) === 'true';
const LOGIN_URL = PAGE_FLAGS.loginUrl || '/accounts/login/';
const MYPAGE_URL = PAGE_FLAGS.mypageUrl || '/accounts/mypage/';
const CURRENT_PATH = PAGE_FLAGS.currentPath || window.location.pathname;
</script>

<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* お気に入り済みスタイル */
.btn-favorite.favorited {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
    border-color: #dc2626;
}

.btn-favorite.favorited:hover {
    background: linear-gradient(135deg, #b91c1c, #991b1b);
}

.btn-favorite.favorited i {
    fill: currentColor;
}

/* ログイン要求ボタンのスタイル */
.btn-favorite.btn-login-required {
    background: var(--gray-100);
    border-color: var(--gray-300);
    color: var(--gray-600);
    text-decoration: none;
}

.btn-favorite.btn-login-required:hover {
    background: var(--gray-200);
    border-color: var(--gray-400);
    color: var(--gray-700);
}

/* お気に入りボタン無効化時のスタイル */
.btn-favorite:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    pointer-events: none;
}

.btn-favorite:disabled:hover {
    background: inherit;
    border-color: inherit;
    color: inherit;
    transform: none;
}
</style>
{% endblock %}